---
import MainLayout from "../layouts/MainLayout.astro";
import { getEpisodes, formatEpisodeId } from "../data/episodes.js";

const episodes = getEpisodes();
const findRandomQuote = (name) => {
  const allQuotes = episodes.flatMap((episode) =>
    episode.all_quotes
      .map((quote, quoteIndex) => ({
        quote,
        quoteIndex,
        episode
      }))
      .filter((entry) => entry.quote.character.toLowerCase().includes(name))
  );

  return allQuotes[Math.floor(Math.random() * allQuotes.length)];
};

const dwight = findRandomQuote("dwight");
const michael = findRandomQuote("michael");
const creed = findRandomQuote("creed");

const cards = [
  {
    name: "Dwight",
    image: "/img/dwight_portrait.jpg",
    data: dwight
  },
  {
    name: "Michael",
    image: "/img/michael_portrait.jpg",
    data: michael
  },
  {
    name: "Creed",
    image: "/img/creed_portrait.jpg",
    data: creed
  }
];
---
<MainLayout
  title="OfficeQuotes.xyz - The Office Quotes"
  description="All the quotes from The Office (US)."
  canonical="https://officequotes.xyz/"
>
  <section class="hero">
    <div>
      <h1>Every Office quote, searchable and fast.</h1>
      <p>
        A lovingly curated catalog of The Office (US) dialogue. Explore by season,
        dive into every episode, or search the entire archive instantly.
      </p>
    </div>
  </section>

  <section class="search-box home-search">
    <label>
      <span class="search-meta">Start typing to search quotes.</span>
      <input
        type="search"
        placeholder="Search quotes, characters, episodes"
        aria-label="Search quotes"
        data-home-search
        autocomplete="off"
      />
    </label>
    <div class="search-meta">Typing opens the full search page.</div>
  </section>

  <section class="card-grid">
    {cards.map((card) => (
      <article class="quote-card">
        <img src={card.image} alt={`Portrait of ${card.name}`} loading="lazy" />
        <div class="meta">{card.name}</div>
        <h3>{card.data.episode.episode_name}</h3>
        <p>"{card.data.quote.text}"</p>
        <a href={`/episode/${formatEpisodeId(card.data.episode.season, card.data.episode.episode)}#quote-${formatEpisodeId(card.data.episode.season, card.data.episode.episode)}-${card.data.quoteIndex}`}>
          Jump to quote ->
        </a>
      </article>
    ))}
  </section>

  <script is:inline>
    const homeSearchInput = document.querySelector('[data-home-search]');
    if (homeSearchInput) {
      homeSearchInput.addEventListener('input', (event) => {
        const value = event.target.value.trim();
        if (!value || homeSearchInput.dataset.redirecting) return;
        homeSearchInput.dataset.redirecting = '1';
        const url = new URL('/search', window.location.origin);
        url.searchParams.set('q', value);
        window.location.href = `${url.pathname}${url.search}`;
      });

      homeSearchInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        const value = event.target.value.trim();
        if (!value) return;
        const url = new URL('/search', window.location.origin);
        url.searchParams.set('q', value);
        window.location.href = `${url.pathname}${url.search}`;
      });
    }
  </script>
</MainLayout>
